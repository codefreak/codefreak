<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
  <title th:text="${assignment.title}" />
</head>
<body>
<div layout:fragment="content">
  <h1 th:text="${assignment.title}" />
  <div class="lead text-muted" th:text="|${#lists.size(taskInfos)} task(s)|" />

  <div class="alert alert-warning mt-4" th:if="${#bools.isTrue(ideCouldNotBeStarted) || (needsNewIdeContainer && !canStartNewIdeContainer)}">
    Currently, no new online IDEs can be started because of server capacity limits. You can still download sources and upload solutions manually.
  </div>
  <div class="alert alert-success mt-4" th:if="${successMessage != null}" th:text="${successMessage}"></div>
  <div class="alert alert-danger mt-4" th:if="${errorMessage != null}" th:text="${errorMessage}"></div>

  <div class="card mt-4" th:each="taskInfo : ${taskInfos}" th:with="task=${taskInfo.task}">
    <div class="card-body">
      <h3 class="card-title" th:text="${task.title}"/>
      <p class="card-text" th:utext="${@markdown.html(task.body)}"/>

      <div class="d-flex flex-row">
        <a class="btn btn-primary ml-1"
           th:href="@{${@urls.get(task)} + '/ide'}"
           target="_blank"
           th:classappend="${!taskInfo.ideRunning && !canStartNewIdeContainer ? 'disabled' : ''}"
           onclick="setTimeout(() => location.reload(), 1000)">
          <i class="far fa-edit"></i> Open in Editor <span th:if="${taskInfo.ideRunning}">(running)</span>
        </a>

        <button th:if="${taskInfo.canStartEvaluation}" class="btn btn-primary start-evaluation ml-1" th:attr="data-task-id=${@urls.getShortId(task.id)}">
          <i class="fas fa-play"></i> Start Evaluation
        </button>
        <a th:if="${taskInfo.latestEvaluation != null}" class="btn btn-primary ml-1" th:href="${@urls.get(taskInfo.latestEvaluation)}"><i class="fas fa-poll"></i> View Evaluation Results</a>

        <button class="ml-auto mr-1 btn btn-light" type="button" data-toggle="modal" th:data-target="|#modal-upload-task-${task.position}|">
          <i class="fas fa-upload"></i> Upload/import source code
        </button>
        <div class="d-inline-block dropdown">
          <button class="btn btn-light dropdown-toggle" type="button" data-toggle="dropdown">
            <i class="fas fa-download"></i> Download source code
          </button>
          <div class="dropdown-menu">
            <a class="dropdown-item" th:href="@{${@urls.get(task)} + '/source.zip'}">zip-Archive (.zip)</a>
            <a class="dropdown-item" th:href="@{${@urls.get(task)} + '/source.tar'}">tar-Archive (.tar)</a>
          </div>
        </div>
      </div>

      <div th:id="|modal-upload-task-${task.position}|" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" th:text='|Upload/Import files for "${task.title}"|'/>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form class="mb-4" th:action="@{${@urls.get(task)} + '/source'}" method="post" enctype="multipart/form-data">
                <h5>Upload files from computer</h5>
                <div class="row">
                  <div class="col">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Archive:</span>
                      </div>
                      <div class="custom-file">
                        <input type="file" required name="file" class="custom-file-input" th:id="|task-file-upload-${task.position}|" accept=".tar,.zip">
                        <label class="custom-file-label" th:for="|task-file-upload-${task.position}|">Please select an archiveâ€¦</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-primary"><i class="fas fa-upload"></i> Upload Source</button>
                  </div>
                </div>
                <div class="form-text text-muted small">
                  Supported formats: .tar, .zip
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              </form>
              <div th:if="${#lists.size(supportedGitRemotes)}">
                <form th:action="@{${@urls.get(task)} + '/git-import'}" method="post" enctype="multipart/form-data">
                  <h5>Import from Git</h5>
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <div class="form-group">
                    <input type="text" name="remoteUrl" class="form-control"
                           placeholder="ssh://git@example.org:1234/path/to/project.git"
                           required
                           pattern="^ssh://.+$">
                    <div class="form-text text-muted small">Use the Git clone URL and please make sure your link starts with <code>ssh://</code></div>
                    <div class="form-text text-muted small" th:text="'Supported services: ' + ${#strings.listJoin(supportedGitRemotes, ', ')}"></div>
                  </div>
                  <input type="submit" class="btn btn-primary" value="Import from Git">
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div layout:fragment="scripts">
  <script src="/assets/assignment.js"></script>
</div>
</body>
</html>
