# This file is meant for local development/testing and NOT meant for production!
# The backend and frontend is built on startup so first run may take some time

version: "3"
services:
  proxy:
    image: traefik:v1.7
    ports:
      - "8081:80"
    command: "--docker --docker.exposedbydefault=false --docker.watch=true"
    network_mode: bridge
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
  frontend:
    depends_on:
      - backend
    image: node:17-alpine
    ports:
      - "3000:3000"
    working_dir: /app/client
    networks:
      - default
      - private
    environment:
      NODE_PROXY_HOST: "backend"
    entrypoint: >
      /bin/sh -c "
        npm install
        until [ -f /app/build/generated/graphql/schema.graphqls ]
        do
          sleep 5
          echo 'Waiting for GraphQL schema generated by backend...'
        done
        npm run generate
        npm start
      "
    volumes:
      - .:/app
  backend:
    depends_on:
      - postgres
    image: gradle:jdk8
    restart: always
    working_dir: /home/gradle/project
    networks:
      - private
    volumes:
      - ".:/home/gradle/project"
      - "/var/run/docker.sock:/var/run/docker.sock"
    command: ./gradlew generateGraphqlSchema bootRun
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/postgres"
      SPRING_DATASOURCE_USERNAME: "postgres"
      SPRING_DATASOURCE_DRIVERCLASSNAME: "org.postgresql.Driver"
      SPRING_JPA_DATABASEPLATFORM: "org.hibernate.dialect.PostgreSQLDialect"
  postgres:
    image: postgres
    restart: always
    networks:
      - private
    environment:
      - "POSTGRES_HOST_AUTH_METHOD=trust"

networks:
  private: {}
